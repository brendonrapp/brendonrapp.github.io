
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Economy of Effort</title>
  <meta name="author" content="Brendon Rapp">

  
  <meta name="description" content="Here&rsquo;s some behavior you might not expect when using Postgres&rsquo;s hstore with ActiveRecord. ActiveRecord::Base#update_attributes does what &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.economyofeffort.com/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Economy of Effort" type="application/atom+xml">
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3578812-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <div id="logo">
    <a href="/"><img src="/images/icons/area.jpg" alt="logo"></a>
  </div>
  <h1><a href="/">Economy of Effort</a></h1>
  
  <div class="clear"></div>
</hgroup>

<hgroup>
  <div id="social-icons">
    <a href="http://www.twitter.com/legion"><img src="/images/icons/webicon-twitter.png" alt="Twitter"></a>
    <a href="http://www.linkedin.com/in/legion/"><img src="/images/icons/webicon-linkedin.png" alt="LinkedIn"></a>
    <a href="http://github.com/brendonrapp"><img src="/images/icons/webicon-github.png" alt="GitHub"></a>
    <a href="mailto:brendon@economyofeffort.com"><img src="/images/icons/webicon-mail.png" alt="Mail"></a>
    <a href="atom.xml"><img src="/images/icons/webicon-rss.png" alt="RSS"></a>
  </div>
</hgroup>

</header>
  <nav role="navigation">
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.economyofeffort.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>

<ul class="main-navigation">
  <li><a href="/about">About</a></li>
  <li><a href="/archives">Archive</a></li>
  <li><a href="http://www.pinterest.com/legion/stuff-i-want/">Wish List</a></li>
  <li><a href="http://steamcommunity.com/id/legion/wishlist/">Steam Wish List</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/2014/12/16/activerecord-save-not-updating-hstore-fields-in-rails-4-dot-0-4-dot-1/">ActiveRecord Save Not Updating Hstore Fields in Rails 4.0-4.1</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2014-12-16T20:10:00-08:00" pubdate data-updated="true">Dec 16<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Here&rsquo;s some behavior you might not expect when using Postgres&rsquo;s hstore with ActiveRecord.</p>

<p>ActiveRecord::Base#update_attributes does what you&rsquo;d think:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">thing</span> <span class="o">=</span> <span class="no">Thing</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">thing</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">({</span><span class="ss">data</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;mykey&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;myval&#39;</span><span class="p">}})</span>
</span><span class='line'><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">thing</span><span class="o">.</span><span class="n">reload</span>
</span><span class='line'><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">thing</span><span class="o">.</span><span class="n">data</span><span class="o">[</span><span class="s1">&#39;mykey&#39;</span><span class="o">]</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="s2">&quot;myval&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, ActiveRecord::Base#save might not:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">thing</span> <span class="o">=</span> <span class="no">Thing</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">thing</span><span class="o">.</span><span class="n">data</span><span class="o">[</span><span class="s1">&#39;mykey&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;myval&#39;</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="s2">&quot;myval&quot;</span>
</span><span class='line'><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">thing</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>   <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="n">ms</span><span class="p">)</span>  <span class="k">BEGIN</span>
</span><span class='line'>  <span class="no">SQL</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">4</span><span class="n">ms</span><span class="p">)</span>  <span class="no">INSERT</span> <span class="no">INTO</span> <span class="s2">&quot;things&quot;</span> <span class="p">(</span><span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="s2">&quot;updated_at&quot;</span><span class="p">)</span> <span class="no">VALUES</span> <span class="p">(</span><span class="vg">$1</span><span class="p">,</span> <span class="vg">$2</span><span class="p">)</span> <span class="no">RETURNING</span> <span class="s2">&quot;id&quot;</span>  <span class="o">[[</span><span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="s2">&quot;2014-12-17 04:02:03.119354&quot;</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;updated_at&quot;</span><span class="p">,</span> <span class="s2">&quot;2014-12-17 04:02:03.119354&quot;</span><span class="o">]]</span>
</span><span class='line'>   <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">9</span><span class="n">ms</span><span class="p">)</span>  <span class="no">COMMIT</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">thing</span><span class="o">.</span><span class="n">reload</span>
</span><span class='line'><span class="o">[</span><span class="mi">4</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">thing</span><span class="o">.</span><span class="n">data</span><span class="o">[</span><span class="s1">&#39;mykey&#39;</span><span class="o">]</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="kp">nil</span>
</span></code></pre></td></tr></table></div></figure>


<p>Huh? I left the SQL log line in the output here so we can see that our hstore field is indeed left out of the SQL INSERT statement entirely, which explains why the field is <code>nil</code> once we re-fetch the object from the database.</p>

<p>But why is it doing this? It turns out that, in Rails 4.0 and 4.1, this operation doesn&rsquo;t mark the field as &ldquo;dirty&rdquo; in ActiveRecord, so the change is not detected and included in the save operation.</p>

<p>We can mark it manually with <a href="http://api.rubyonrails.org/classes/ActiveModel/Dirty.html">ActiveModel::Dirty</a>&rsquo;s <code>attr_name_will_change!</code>, eg.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">thing</span> <span class="o">=</span> <span class="no">Thing</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">thing</span><span class="o">.</span><span class="n">data_will_change!</span>
</span><span class='line'><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">thing</span><span class="o">.</span><span class="n">data</span><span class="o">[</span><span class="s1">&#39;mykey&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;myval&#39;</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="s2">&quot;myval&quot;</span>
</span><span class='line'><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">thing</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>   <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="n">ms</span><span class="p">)</span>  <span class="k">BEGIN</span>
</span><span class='line'>  <span class="no">SQL</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="n">ms</span><span class="p">)</span>  <span class="no">INSERT</span> <span class="no">INTO</span> <span class="s2">&quot;things&quot;</span> <span class="p">(</span><span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;updated_at&quot;</span><span class="p">)</span> <span class="no">VALUES</span> <span class="p">(</span><span class="vg">$1</span><span class="p">,</span> <span class="vg">$2</span><span class="p">,</span> <span class="vg">$3</span><span class="p">)</span> <span class="no">RETURNING</span> <span class="s2">&quot;id&quot;</span>  <span class="o">[[</span><span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="s2">&quot;2014-12-17 04:08:32.066027&quot;</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">mykey</span><span class="se">\&quot;</span><span class="s2">=&gt;</span><span class="se">\&quot;</span><span class="s2">myval</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;updated_at&quot;</span><span class="p">,</span> <span class="s2">&quot;2014-12-17 04:08:32.066027&quot;</span><span class="o">]]</span>
</span><span class='line'>   <span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="n">ms</span><span class="p">)</span>  <span class="no">COMMIT</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="o">[</span><span class="mi">4</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">thing</span><span class="o">.</span><span class="n">reload</span>
</span><span class='line'><span class="o">[</span><span class="mi">5</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">thing</span><span class="o">.</span><span class="n">data</span><span class="o">[</span><span class="s1">&#39;mykey&#39;</span><span class="o">]</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="s2">&quot;myval&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The documentation states that <code>attr_name_will_change!</code> should be called <em>before</em> changes to the attribute, as seen in the example above.</p>

<p>Doesn&rsquo;t this seem like a pain? Well, as discussed in <a href="https://github.com/rails/rails/issues/6127">Rails issue #6127</a>, it was expected behavior for Rails 4.0 and 4.1, but improvements to serialized attributes have been <a href="https://github.com/rails/rails/pull/15674">merged into Rails</a> and will appear in Rails 4.2. Setting values and calling save will just work.</p>

<p>So, in the meantime, the workaround is manually marking properties as dirty with <code>attr_data_will_change!</code> before making and saving changes to those fields.</p>
</div>
  
  
    <footer>
      <p class="meta">
        categories: 

<span class="categories">
  
    <a class='category' href='/categories/hstore/'>hstore</a>, <a class='category' href='/categories/postgres/'>postgres</a>, <a class='category' href='/categories/rails/'>rails</a>, <a class='category' href='/categories/ruby/'>ruby</a>
  
</span>


      </p>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/2014/12/16/postgres-hstore-default-value-in-rails-4/">PostgreSQL Hstore Default Value in Rails 4</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2014-12-16T19:02:00-08:00" pubdate data-updated="true">Dec 16<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Having used <a href="https://github.com/diogob/activerecord-postgres-hstore">activerecord-postgres-hstore</a> before native hstore support was added to Rails 4, I was used to the behavior of empty hstore fields returning an empty hash <code>{}</code> when a row with such a field was instantiated into an ActiveRecord object, as was discussed and added in the gem&rsquo;s <a href="https://github.com/diogob/activerecord-postgres-hstore/issues/22">issue #22</a>.</p>

<p>This behavior changed in Rails 4&rsquo;s hstore support. An ActiveRecord object with an empty hstore field will return <code>nil</code> for that field rather than an empty hash. (When someone opened a bug in the Rails repo to suggest implementing the same behavior in the new native hstore support, <a href="https://github.com/rails/rails/issues/11520">it was brushed off</a>.)</p>

<p>By default, that leaves us to have to nil-check every hstore property in our objects before accessing any keys (eg. <code>@myobj.data &amp;&amp; @myobj.data['mykey']</code>). However, we can get our &ldquo;empty&rdquo; hstore fields instantiating as empty hashes instead of nil with a tweak of our migration.</p>

<p>Simply add <code>default: '', null: false</code> to the migration, eg.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">AddDataToThings</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">change</span>
</span><span class='line'>    <span class="n">add_column</span> <span class="ss">:things</span><span class="p">,</span> <span class="ss">:data</span><span class="p">,</span> <span class="ss">:hstore</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>With that default in place, our empty hstore fields will instantiate as empty hashes, and we can avoid the nil check:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">thing</span> <span class="o">=</span> <span class="no">Thing</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="c1">#&lt;Thing id: nil, ... &gt;</span>
</span><span class='line'><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="no">Thing</span><span class="o">.</span><span class="n">data</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="p">{}</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  
    <footer>
      <p class="meta">
        categories: 

<span class="categories">
  
    <a class='category' href='/categories/hstore/'>hstore</a>, <a class='category' href='/categories/postgres/'>postgres</a>, <a class='category' href='/categories/rails/'>rails</a>, <a class='category' href='/categories/ruby/'>ruby</a>
  
</span>


      </p>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/2014/08/11/beyond-ctrl-remap-make-that-caps-lock-key-useful/">Beyond Ctrl: Make That Caps Lock Key Useful</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2014-08-11T14:19:00-07:00" pubdate data-updated="true">Aug 11<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>tl;dr: Supercharge your Caps Lock key by making it Esc when tapped, and Ctrl when held</strong></p>

<p>Caps Lock. A useless key sitting in prime keyboard real estate. Many software developers and power users repurpose the key by remapping it to Control.</p>

<p>After all, on old UNIX terminals, that&rsquo;s exactly what the key to the left of &ldquo;A&rdquo; was:</p>

<p><img src="/media/images/sun-keyboard.png" alt="" /></p>

<p>Replacing the Caps Lock key with Ctrl makes a lot of keyboard shortcuts more convenient. But we need not stop there. Some true Men and Women of Genius came to the realization that, since Ctrl&rsquo;s behavior is based around behind held down (a modifier key) and doesn&rsquo;t do anything when pressed and released, it is possible to make Caps Lock do something <em>else</em> when tapped instead of held. For Vim users, the obvious choice is the Esc key.</p>

<p>We can do this in both Mac OS X and Linux.</p>

<h2>OS X</h2>

<h3>If you want all Ctrl keys to behave like Esc when tapped</h3>

<p>This is the easiest way, and the option I use. (I rarely find myself hitting the normal Ctrl keys anyway.)</p>

<p>First, open System Preferences &ndash;> Keyboard, and click Modifier Keys button. Click the Caps Lock drop-down and set it to Control:</p>

<p><img src="/media/images/osx-remap-esc-key.png" alt="" /></p>

<p>Now, install <a href="https://pqrs.org/osx/karabiner/">Karabiner</a> (formerly known as KeyRemap4MacBook). If you are a Homebrew user, you should check out <a href="https://github.com/caskroom/homebrew-cask">Homebrew Cask</a> and install Karabiner with <code>$ brew cask install karabiner</code></p>

<p>Open Karabiner. Enable the first setting from the screenshot below:</p>

<p><img src="/media/images/karabiner-1.png" alt="" /></p>

<p>The other option I have there, &ldquo;Disable Escape Key&rdquo;, is something I&rsquo;ve done just to get myself in the habit of using the Caps Lock key for Esc. It is not required, it is just an option if you want to help train yourself to use the new key.</p>

<h3>If you only want the Caps Lock key to behave like Esc when tapped</h3>

<p>To do this, we&rsquo;re going to take a slightly different approach. Instead of using OS X&rsquo;s native Caps Lock remapping, we need to use another app, called <a href="https://pqrs.org/osx/karabiner/seil.html">Seil</a> (from the same developer as Karabiner) to remap the Esc key to F19, and then use Karabiner to map F19 to our cool Ctrl/Esc hybrid key.</p>

<p>Install both <a href="https://pqrs.org/osx/karabiner/">Karabiner</a> and <a href="https://pqrs.org/osx/karabiner/seil.html">Seil</a>. (Here again, if you use <a href="https://github.com/caskroom/homebrew-cask">Homebrew Cask</a>, you can do this with <code>$ brew cask install karabiner</code> and <code>$ brew cask install seil</code>)</p>

<p>Open Seil. First, enable the &ldquo;Change Caps Lock&rdquo; option, and set the keycode to 80:</p>

<p><img src="/media/images/seil.png" alt="" /></p>

<p>Next, in Karabiner, enable the &ldquo;F19 for Escape and Control&rdquo; option:</p>

<p><img src="/media/images/karabiner-2.png" alt="" /></p>

<h2>Linux</h2>

<p>To accomplish the same setup in Linux, we need to use a tool called <a href="https://github.com/alols/xcape">xcape</a>.</p>

<p>Build and install xcape per the instructions on the project&rsquo;s Wiki page. One additional step I take after building the app is copying the <code>xcape</code> executable to /usr/local/bin.</p>

<h3>If you only want the Caps Lock key to behave like Esc when tapped</h3>

<p>Add the following lines to your ~/.profile:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>setxkbmap -option 'caps:ctrl_modifier'
</span><span class='line'>xcape -e 'Caps_Lock=Escape'</span></code></pre></td></tr></table></div></figure>


<h3>If you want all Ctrl keys to behave like Esc when tapped</h3>

<p>Same as above, except we add more arguments to the xcape line:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>setxkbmap -option 'caps:ctrl_modifier'
</span><span class='line'>xcape -e 'Caps_Lock=Escape;Control_L=Escape;Control_R=Escape'</span></code></pre></td></tr></table></div></figure>


<p>Note: If you use some other method of remapping the Caps Lock key to Ctrl (some desktop environments have it as an option in their Keyboard settings, much like OS X), then the Caps_Lock=Escape mapping may not do anything, and you will need to use the Control_L one.</p>

<p>One last little tidbit: Ubuntu 14.10 (&ldquo;Utopic&rdquo;) has xcape <a href="http://packages.ubuntu.com/utopic/xcape">in the universe repos</a>, at least as of the time of this writing. Hopefully it will be included in Ubuntu releases from here on out.</p>

<h2>Now Your Caps Lock Key Rules</h2>

<p>The most useless key on the keyboard (except maybe for Pause, when&rsquo;s the last time you used that?) is now your Swiss Army knife. Vim&rsquo;s keybindings will make a lot more sense now that you can use your pinky the way Bill Joy did on his old ADM3A terminal:</p>

<p><img src="/media/images/adm3a.png" alt="" /></p>
</div>
  
  
    <footer>
      <p class="meta">
        categories: 

<span class="categories">
  
    <a class='category' href='/categories/os-x/'>OS X</a>, <a class='category' href='/categories/caps-lock/'>caps lock</a>, <a class='category' href='/categories/homebrew/'>homebrew</a>, <a class='category' href='/categories/keyboards/'>keyboards</a>, <a class='category' href='/categories/unix/'>unix</a>, <a class='category' href='/categories/vim/'>vim</a>
  
</span>


      </p>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/2014/07/20/convert-html-to-haml-within-vim-buffer/">Convert HTML to Haml (and Back Again) Within a Vim Buffer</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2014-07-20T13:36:00-07:00" pubdate data-updated="true">Jul 20<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://haml.info/">Haml</a> is great. Haml is the JSON to HTML&rsquo;s XML: all of the garbage and noise stripped away, with only the data and minimal amount of ceremony left.</p>

<p>I use Haml on all Rails projects now, but when dealing with legacy projects, I still encounter HTML/ERb templates.</p>

<p>Using the <a href="https://github.com/haml/html2haml">html2haml</a> command-line tool, I can easily convert HTML/ERb in my Vim buffer into Haml.</p>

<p>The project distributes as a Ruby gem, so installing is accomplished with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gem install html2haml
</span></code></pre></td></tr></table></div></figure>


<p>Then, the magic is done with some Vim bindings to feed a buffer or visually-selected chunk of text to the application, and paste its output back into the buffer, replacing the original text.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'>nmap <span class="p">&lt;</span>leader<span class="p">&gt;</span><span class="k">h</span> :%<span class="p">!</span>html2haml <span class="p">--</span>erb <span class="m">2</span><span class="p">&gt;</span> <span class="sr">/dev/</span>null<span class="p">&lt;</span>CR<span class="p">&gt;</span>:<span class="k">set</span> <span class="nb">ft</span><span class="p">=</span>haml<span class="p">&lt;</span>CR<span class="p">&gt;</span>
</span><span class='line'>vmap <span class="p">&lt;</span>leader<span class="p">&gt;</span><span class="k">h</span> :<span class="p">!</span>html2haml <span class="p">--</span>erb <span class="m">2</span><span class="p">&gt;</span> <span class="sr">/dev/</span>null<span class="p">&lt;</span>CR<span class="p">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>When changing the entire file, I&rsquo;ve also added the command to change the filetype in the Vim buffer, for convenience.</p>

<p>That takes us from HTML/ERb to Haml, but what if we need to go back in the other direction? This is possible with the <a href="https://github.com/elia/haml2erb">haml2erb</a> tool. Unfortunately, this tool is not actively maintained the way html2haml is. For me, on Ruby 2.1.1, it was necessary to install the 0.3.0 prerelease version, as the last official version would not build. Once installed, though, it worked as expected.</p>

<p>We must explicitly indicate which version to install in order to install prerelease gems:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gem install haml2erb -v <span class="s1">&#39;0.3.0.pre.3&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The Vim bindings are much the same as the html2haml ones:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'>nmap <span class="p">&lt;</span>leader<span class="p">&gt;</span><span class="k">e</span> :%<span class="p">!</span>haml2erb <span class="m">2</span><span class="p">&gt;</span> <span class="sr">/dev/</span>null<span class="p">&lt;</span>CR<span class="p">&gt;</span>:<span class="k">set</span> <span class="nb">ft</span><span class="p">=</span>eruby<span class="p">&lt;</span>CR<span class="p">&gt;</span>
</span><span class='line'>vmap <span class="p">&lt;</span>leader<span class="p">&gt;</span><span class="k">e</span> :<span class="p">!</span>haml2erb <span class="m">2</span><span class="p">&gt;</span> <span class="sr">/dev/</span>null<span class="p">&lt;</span>CR<span class="p">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I have not used this nearly as much as html2haml, as I&rsquo;m rarely changing layout code from Haml back into HTML. However, the couple of times I have needed to do it, it has worked exactly as expected..</p>
</div>
  
  
    <footer>
      <p class="meta">
        categories: 

<span class="categories">
  
    <a class='category' href='/categories/erb/'>erb</a>, <a class='category' href='/categories/haml/'>haml</a>, <a class='category' href='/categories/html/'>html</a>, <a class='category' href='/categories/ruby/'>ruby</a>, <a class='category' href='/categories/vim/'>vim</a>
  
</span>


      </p>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/2014/07/20/fixed-the-archive-page/">Fixed the Archive Page</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2014-07-20T02:18:00-07:00" pubdate data-updated="true">Jul 20<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Finally got around to fixing the Archive page on this site.</p>

<p>If I recall correctly, what happened originally is that I was attempting to get rid of the &ldquo;/blog/&rdquo; part of the archive path, but got distracted halfway through and left it incomplete.</p>

<p>For reference: this part of the archive path is not a user-configurable part of Octopress per se. It is a default location for a file in Jekyll, which is in <code>source/blog/archive</code> in an Octopress site repository. Simply moving the <code>archive/</code> folder out of <code>blog/</code> and into the top level of <code>source/</code> will make the archive page generate without the &ldquo;/blog/&rdquo; part of the page. (For further reference, see <a href="https://github.com/imathis/octopress/issues/464#issuecomment-5587568">the workaround post</a> on the <a href="https://github.com/imathis/octopress/issues/464">issue on Github</a>)</p>
</div>
  
  
    <footer>
      <p class="meta">
        categories: 

<span class="categories">
  
    <a class='category' href='/categories/octopress/'>octopress</a>
  
</span>


      </p>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/2014/07/09/vim-tricks-for-ruby-hashes/">Vim Tricks for Ruby Hashes</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2014-07-09T19:59:00-07:00" pubdate data-updated="true">Jul 9<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have a couple of functions in my .vimrc for manipulating Ruby hashes.</p>

<p>The first one is to convert hashes from Ruby 1.8 style into Ruby 1.9+ style, eg.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># before</span>
</span><span class='line'><span class="ss">:symbol_key</span> <span class="o">=&gt;</span> <span class="s1">&#39;value&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># after</span>
</span><span class='line'><span class="n">symbol_key</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I create this function for both Normal and Visual modes to allow updating either a selected hash, or the entire file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'><span class="k">function</span><span class="p">!</span> RubyHashesAll<span class="p">()</span>
</span><span class='line'>  :%<span class="k">s</span><span class="sr">/:\([^ ]*\)\(\s*\)=&gt;/</span>\<span class="m">1</span>:/ge
</span><span class='line'><span class="k">endfunction</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span><span class="p">!</span> RubyHashesSelected<span class="p">()</span>
</span><span class='line'>  :<span class="s1">&#39;&lt;,&#39;</span><span class="p">&gt;</span><span class="k">s</span><span class="sr">/:\([^ ]*\)\(\s*\)=&gt;/</span>\<span class="m">1</span>:/ge
</span><span class='line'><span class="k">endfunction</span>
</span><span class='line'>
</span><span class='line'>nmap <span class="p">&lt;</span>Leader<span class="p">&gt;</span>rhh :<span class="k">call</span> RubyHashesAll<span class="p">()&lt;</span>CR<span class="p">&gt;</span>
</span><span class='line'>vmap <span class="p">&lt;</span>Leader<span class="p">&gt;</span>rhh :<span class="k">call</span> RubyHashesSelected<span class="p">()&lt;</span>CR<span class="p">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, I have one for taking a hash and extracting an array of the hash keys.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># before</span>
</span><span class='line'><span class="p">{</span> <span class="s1">&#39;one&#39;</span> <span class="o">=&gt;</span> <span class="n">two</span><span class="p">,</span> <span class="ss">:three</span> <span class="o">=&gt;</span> <span class="s1">&#39;four&#39;</span><span class="p">,</span> <span class="ss">five</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># after</span>
</span><span class='line'><span class="o">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="ss">:three</span><span class="p">,</span> <span class="ss">:five</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, I have the command bound only in Visual mode, as I don&rsquo;t see a case where I&rsquo;d want to do this globally.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'><span class="k">function</span><span class="p">!</span> RubyExtractHashKeys<span class="p">()</span>
</span><span class='line'>  :<span class="s1">&#39;&lt;,&#39;</span><span class="p">&gt;</span><span class="k">s</span><span class="sr">/\([:&#39;&quot;]\?[a-zA-Z]\+[&#39;&quot;]\?\)\s*=&gt;[^,}]\+\([,}]\)/</span>\<span class="m">1</span>\<span class="m">2</span>/ge
</span><span class='line'>  :<span class="s1">&#39;&lt;,&#39;</span><span class="p">&gt;</span><span class="k">s</span><span class="sr">/\([a-zA-Z]\+\)[:]\s*[^,}]\+\([,}]\)/</span>:\<span class="m">1</span>\<span class="m">2</span>/ge
</span><span class='line'>  :<span class="s1">&#39;&lt;,&#39;</span><span class="p">&gt;</span><span class="k">s</span><span class="sr">/{\s*/</span>\[/ge
</span><span class='line'>  :<span class="s1">&#39;&lt;,&#39;</span><span class="p">&gt;</span><span class="k">s</span><span class="sr">/\s*}/</span>\]/ge
</span><span class='line'><span class="k">endfunction</span>
</span><span class='line'>
</span><span class='line'>vmap <span class="p">&lt;</span>Leader<span class="p">&gt;</span>rhe :<span class="k">call</span> RubyExtractHashKeys<span class="p">()&lt;</span>CR<span class="p">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The regexes can probably be improved to fix some edge cases, and I&rsquo;m certain there&rsquo;s a way in Vim to make it so that I don&rsquo;t have to define the All and Selected versions of RubyHashes as separate functions. But these do the job for me now, until I reach a higher plane of Vim mastery.</p>
</div>
  
  
    <footer>
      <p class="meta">
        categories: 

<span class="categories">
  
    <a class='category' href='/categories/ruby/'>ruby</a>, <a class='category' href='/categories/vim/'>vim</a>
  
</span>


      </p>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/2014/07/04/zsh/">Zsh, Tmux, Vim, and 256 Color Madness</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2014-07-04T21:20:00-07:00" pubdate data-updated="true">Jul 4<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>tl;dr: You want $TERM to be <code>screen-256color</code> when tmux is running, and you want it to be <code>xterm-256color</code> when tmux is <em>not</em> running. Also, launch tmux with <code>-2</code> argument.</strong></p>

<p>I love <a href="https://wiki.archlinux.org/index.php/Tmux">tmux</a>. It is the primary reason why I switched from using gVim to console vim. I love having a fully terminal-based workflow. It beats switching between a GUI editor app and terminal window any day.</p>

<p>This switch, however, was not without some issues. Here are the solutions to two that I encountered.</p>

<h3>Weirdness with zsh, tmux, and vim</h3>

<h4>Problems:</h4>

<ul>
<li>when $TERM is <code>screen-256color</code> but tmux is <em>not</em> running, zsh will echo your command into the output when you hit Enter:</li>
</ul>


<p><img src="/media/images/screen-256color-no-tmux.png" alt="" /></p>

<p>Notice how the output of the &ldquo;ls&rdquo; and &ldquo;echo&rdquo; commands repeat themselves in the output stream as soon as I switched to <code>screen-256color</code>.</p>

<ul>
<li>when $TERM is <code>xterm-256color</code> while tmux is running, colors will not display properly in Vim:</li>
</ul>


<p style="text-align:left !important;"><code>vim /etc/default/grub</code> while <code>TERM=screen-256color</code>:</p>


<p><img src="/media/images/tmux-vim-screen-256color.png" alt="" /></p>

<p style="text-align:left !important;"><code>vim /etc/default/grub</code> while <code>TERM=xterm-256color</code>:</p>


<p><img src="/media/images/tmux-vim-xterm-256color.png" alt="" /></p>

<h4>Solution:</h4>

<p>In my zsh config (~/.zshrc), I set xterm-256color to be the default TERM, but right after that, added a command that would re-export TERM as screen-256color if tmux is running:</p>

<pre><code>export TERM=xterm-256color
[ -n "$TMUX" ] &amp;&amp; export TERM=screen-256color
</code></pre>

<h3>No Vim colorschemes when tmux is launched by terminal app in place of shell</h3>

<h4>Problem:</h4>

<p>I ran into a specific set of circumstances where my Vim colorscheme would not display.</p>

<p>Terminal applications usually launch a shell by default, but some (like gnome-terminal) have the option of defining a command to be run rather instead of the shell.</p>

<p>If I set this command to <code>tmux</code>, tmux would indeed launch. However, if I then ran Vim, the colorscheme would not display correctly.</p>

<p>However, if I allowed gnome-terminal to launch a shell, and then ran <code>tmux</code> myself from that shell, Vim would display properly within that tmux session.</p>

<h4>Solution:</h4>

<p>I got my clue from <a href="http://stackoverflow.com/questions/10158508/lose-vim-colorscheme-in-tmux-mode">this StackOverflow post</a>. Basically, what is happening is that, when running <code>tmux</code> from within my shell, which is configured for 256 colors, tmux would launch in 256 color mode. But when I had gnome-terminal launch tmux directly, it would not.</p>

<p>The easy way around this was to use the &ldquo;-2&rdquo; argument for tmux, making the command <code>tmux -2</code>.</p>

<p><img src="/media/images/gnome-terminal-auto-tmux.png" alt="" /></p>

<p>With that command in place, tmux launches whenever firing up gnome-terminal, and does so in 256 color mode.</p>
</div>
  
  
    <footer>
      <p class="meta">
        categories: 

<span class="categories">
  
    <a class='category' href='/categories/tmux/'>tmux</a>, <a class='category' href='/categories/unix/'>unix</a>, <a class='category' href='/categories/vim/'>vim</a>, <a class='category' href='/categories/zsh/'>zsh</a>
  
</span>


      </p>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/2013/08/03/careful-what-you-name-your-rails-partials/">Careful What You Name Your Rails Partials</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-08-03T15:53:00-07:00" pubdate data-updated="true">Aug 3<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>tl;dr: Hyphens bad.</strong></p>

<p>I encountered a strange bug in Rails 3.2.13 this week. I kept getting an error that traced back to the very start of a partial:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>_example-partial-logged-in.html.haml:1: syntax error, unexpected keyword_in, expecting keyword_end</span></code></pre></td></tr></table></div></figure>


<p>I tracked it down to <a href="https://github.com/rails/rails/issues/7079">this issue</a>, which pointed out that the error was related to the hyphenated name ending with a Ruby reserved word.</p>

<p>By convention, Rails uses underscores for word separation in file names. Hyphens are not completely disallowed (the above works if I rename the file to end with a non-reserve word), but can lead to issues.</p>

<p>The issue linked above contains a pull request for a better error message, which was merged into Rails 4. But for those still on Rails 3 and earlier, if you see this vague error message, now you know why.</p>

<p><img class="center" src="/media/images/hyphen.jpg"></p>
</div>
  
  
    <footer>
      <p class="meta">
        categories: 

<span class="categories">
  
    <a class='category' href='/categories/rails/'>rails</a>, <a class='category' href='/categories/ruby/'>ruby</a>
  
</span>


      </p>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/2013/07/29/reattach-to-user-namespace-the-fix-for-your-tmux-in-os-x-woes/">Reattach-to-user-namespace: The Fix for Your Tmux in OS X Woes</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-07-29T17:21:00-07:00" pubdate data-updated="true">Jul 29<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img class="center" src="/media/images/tmux-osx.jpg"></p>

<p><strong>tl;dr: Things not behaving right in tmux on OS X? Install reattach-to-user-namespace</strong></p>

<p>Are you a tmux + Mac OS X user? Have you had any of the following problems?</p>

<ul>
<li>Running <code>launchctl</code> to start services fails with a message like <code>launch_msg(): Socket is not connected</code></li>
<li>Using the OS X Pasteboard commands <code>pbcopy</code> and <code>pbpaste</code> and having them not work</li>
<li>Launching a GUI app from the terminal and getting a &ldquo;ghost window&rdquo;: the app window loads in the background, with no dock icon, cannot be Command-Tab&rsquo;d to, and the app&rsquo;s menu does not populate the top bar when the window gains focus</li>
</ul>


<p>Why does this happen? Chris Johnsen has some <a href="https://github.com/ChrisJohnsen/tmux-MacOSX-pasteboard">details</a>&hellip;</p>

<blockquote><p><em>tmux</em> uses the <em>daemon(3)</em> library function when starting its server process. In Mac OS X 10.5, Apple changed <em>daemon(3)</em> to move the resulting process from its original bootstrap namespace to the root bootstrap namespace. This means that the <em>tmux</em> server, and its children, will automatically and uncontrollably lose access to what would have been their original bootstrap namespace (i.e. the one that has access to the pasteboard service).</p></blockquote>

<p>It turns out that Apple has patched the version of GNU screen that they distribute with OS X to avoid this problem. But this is 2013, and we UNIX geeks have moved on to tmux, right? Chris goes on in that README to explain why porting Apple&rsquo;s screen patch to tmux would be tricky.</p>

<p>So, instead, he provides the <em>reattach-to-user-namespace</em> wrapper program. This allows us to launch a process and have that process be attached to the per-user bootstrap namespace, which, to put it simply, makes the program behave as we are expecting.</p>

<p>The &ldquo;trick&rdquo; is to configure tmux to launch its shells with the <em>reattach-to-user-namespace</em> wrapper. By doing that, the shells tmux launches, as well as everything those shells launch, will be attached to the user namespace, and the problems listed at the top of this post will no longer be issues. We can use the <code>default-command</code> option in ~/.tmux.conf to wrap our shell launching command.</p>

<p>First, we need to install <em>reattach-to-user-namespace</em>. If you use Homebrew or MacPorts, this is as easy as:</p>

<pre><code>; with Homebrew
$ brew install reattach-to-user-namespace

; with MacPorts
$ port install tmux-pasteboard
</code></pre>

<p>I use the same dotfiles for Linux as well as OS X, so I only want to do this in the OS X environment. I accomplish this with the following:</p>

<figure class='code'><figcaption><span>~/.tmux.conf </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'><span class="c">&quot; at the end of the file</span>
</span><span class='line'><span class="k">if</span><span class="p">-</span><span class="k">shell</span> <span class="s1">&#39;test &quot;$(uname)&quot; = &quot;Darwin&quot;&#39;</span> <span class="s1">&#39;source ~/.tmux-osx.conf&#39;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>~/.tmux-osx.conf </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'><span class="k">set</span><span class="p">-</span><span class="k">option</span> <span class="p">-</span><span class="k">g</span> default<span class="p">-</span>command <span class="s2">&quot;reattach-to-user-namespace -l zsh&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you only use OS X, you can skip creating an external file, and just put the set-option line directly in your ~/.tmux.conf. Also, I am using zsh, so my command to <em>reattach-to-user-namespace</em> is zsh. If you&rsquo;re using a different shell, change that to your shell&rsquo;s name.</p>

<p>With this configuration in place, kill and re-launch tmux. The shells that tmux launches should now get attached to the user namespace, and namespace-related issues should be resolved.</p>
</div>
  
  
    <footer>
      <p class="meta">
        categories: 

<span class="categories">
  
    <a class='category' href='/categories/os-x/'>OS X</a>, <a class='category' href='/categories/homebrew/'>homebrew</a>, <a class='category' href='/categories/tmux/'>tmux</a>
  
</span>


      </p>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/2013/07/26/no-numpads/">No Numpads</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-07-26T19:20:00-07:00" pubdate data-updated="true">Jul 26<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>My mother is an accountant. Walk by her office on any given day, and you&rsquo;ll likely hear the mechanical sounds of an accounting calculator printing its results to a stream of paper.</p>

<p><img class="center" src="/wp-content/uploads/2010/12/calculator.jpg" width="350" height="263"></p>

<p>I used to make fun of the endless <em>crunch-crunch-crunch</em> sound that echoed down the hallways. These days, she tells me, the ol&#8217; hand calculator doesn&rsquo;t get quite as much use as before. More and more of the accounting business is computerized.</p>

<p>It comes as little surprise. Computers were invented to crunch numbers. When computers became machines that fit on a desktop, the &ldquo;killer apps&rdquo; were all about numbers: the first two applications named in Wikipedia&rsquo;s <a href="http://en.wikipedia.org/wiki/Killer_application">entry for killer applications</a> are Visicalc and Lotus 1-2-3.</p>

<p>Accordingly, it did not take long for personal computer manufacturers to take inspiration from those hand calculators and add the number pad to the right of the typewriter key layout.</p>

<p><img class="center" src="/wp-content/uploads/2010/12/Terminal-dec-vt100.jpg" width="499" height="391"> Personal computers, however, have moved well beyond the domain of the office desktop. Indeed, for most people, the computer is no longer thought of as a device for performing calculations. They are used for communication, and for accessing and storing data. I don&rsquo;t have data to back it up, but I would wager that most computer users don&rsquo;t punch in long sequences of numbers regularly.</p>

<p>And yet, while the computer has evolved, the number pad remains. Like the wings of a flightless bird. the vestigal number pad sits unused, eating up space on millions of desktops.</p>

<p>Oh sure, you use the number pad, you say. And perhaps you do. But do you really use it enough to dedicate 6 inches of desk width for it? More to the point, does <em>every</em> computer user? People are <a href="http://news.cnet.com/8301-31021_3-20005908-260.html">buying laptops and netbooks</a> for their computing devices more and more, and I don&rsquo;t ever hear people complaining about how much they miss the numpad.</p>

<p>And yet, the vast majority of keyboards for sale include the numpad. Finding keyboards without them takes some effort.</p>

<p>One of the few I became aware of when starting the search was the Happy Hacking Keyboard Lite.</p>

<p><img class="center" src="/wp-content/uploads/2011/02/hhkb-lite.jpg"></p>

<p>It&rsquo;s a nice, small deck. It uses a &ldquo;UNIX&rdquo; keyboard layout, like the ones on the old Sun boxes in one of the computer labs back at university.</p>

<p>Apple has come around on the idea of ditching the numpad. New iMacs come with a wireless keyboard that has no numpad.</p>

<p><img class="center" src="/media/images/imac.jpg"></p>

<p>I considered picking up one of these. And I actually did pick up a couple of Apple&rsquo;s discontinued wired USB tenkeyless keyboards.</p>

<p><img class="center" src="/media/images/apple-compact-keyboard.jpg"></p>

<p>They&rsquo;re not bad as spare keyboards to have around, but they were not going to be my primary keyboard. (My wife is using one on her desktop machine, though).</p>

<p>One keyboard I really want is the 84-key &ldquo;Space Saving&rdquo; version of the IBM Model M.</p>

<p><img class="center" src="/wp-content/uploads/2010/12/spacesaver1280-300x203.jpg"> Sadly, they are awfully hard to come by. I watch for them on <a href="http://www.clickykeyboards.com">clickykeyboards.com</a> but it&rsquo;s just an endless list of <span style="color: #ff0000;"><strong>SOLD</strong></span> boards.</p>

<p>But the keyboard that ended my search was the <a href="http://elitekeyboards.com/products.php?sub=leopold,tenkeyless&amp;pid=fc200rtab">Leopold Tenkeyless Tactile Touch</a> from EliteKeyboards. It combined my desire for a compact no-numpad keyboard with the desire to have a mechanical keyboard.</p>

<p><img class="center" src="/media/images/leopold.jpg"></p>

<p>It&rsquo;s been a couple of years now since I bought this keyboard, and while the idea of spending $100 on a keyboard was a tough pill to swallow at the time, I would not hesitate to do it again. The compact size make life nicer on my desk, and the action of the mechanical key switches is so much more enjoyable than mashing the rubber dome switches on a non-mechanical keyboard.</p>
</div>
  
  
    <footer>
      <p class="meta">
        categories: 

<span class="categories">
  
    <a class='category' href='/categories/computers/'>computers</a>, <a class='category' href='/categories/hardware/'>hardware</a>, <a class='category' href='/categories/keyboards/'>keyboards</a>
  
</span>


      </p>
    </footer>
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2014/12/16/activerecord-save-not-updating-hstore-fields-in-rails-4-dot-0-4-dot-1/">ActiveRecord Save Not Updating Hstore Fields in Rails 4.0-4.1</a>
      </li>
    
      <li class="post">
        <a href="/2014/12/16/postgres-hstore-default-value-in-rails-4/">PostgreSQL Hstore Default Value in Rails 4</a>
      </li>
    
      <li class="post">
        <a href="/2014/08/11/beyond-ctrl-remap-make-that-caps-lock-key-useful/">Beyond Ctrl: Make That Caps Lock Key Useful</a>
      </li>
    
      <li class="post">
        <a href="/2014/07/20/convert-html-to-haml-within-vim-buffer/">Convert HTML to Haml (and Back Again) Within a Vim Buffer</a>
      </li>
    
      <li class="post">
        <a href="/2014/07/20/fixed-the-archive-page/">Fixed the Archive Page</a>
      </li>
    
  </ul>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Brendon Rapp -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'economyofeffort';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
